<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Zoro AI | Premium Financial Dashboard</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root { --indigo-primary:#6366f1; --emerald-accent:#10b981; }

    body{
      font-family:'Plus Jakarta Sans',sans-serif;
      background:radial-gradient(circle at 0% 0%, #0f172a 0%, #020617 100%);
      color:#f8fafc; min-height:100vh;
    }

    .glass-panel{
      background:rgba(30,41,59,.4);
      backdrop-filter:blur(20px);
      border:1px solid rgba(255,255,255,.08);
      border-radius:2.5rem;
      transition:all .5s ease;
    }
    .glass-panel:hover{
      border-color:rgba(99,102,241,.4);
      background:rgba(30,41,59,.6);
      transform:translateY(-6px);
    }

    .nav-link{ position:relative; transition:color .3s; }
    .nav-link.active::after{
      content:'';
      position:absolute; bottom:-10px; left:0;
      width:100%; height:3px;
      background:linear-gradient(90deg,#6366f1,#22d3ee);
      border-radius:10px;
    }

    /* ===== Chat UI (scoped) ===== */
    .chat-scroll::-webkit-scrollbar{ width:4px; }
    .chat-scroll::-webkit-scrollbar-track{ background:transparent; }
    .chat-scroll::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.1); border-radius:10px; }

    .animate-in{ animation:fadeInUp .8s cubic-bezier(.16,1,.3,1) forwards; opacity:0; }
    @keyframes fadeInUp{ from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }
  </style>
</head>

<body class="p-8 lg:p-12">

<header class="flex justify-between items-center mb-16">
  <div>
    <h1 class="text-4xl font-extrabold bg-gradient-to-r from-indigo-400 to-cyan-400 bg-clip-text text-transparent">ZORO AI</h1>
    <p class="text-slate-500 text-xs uppercase tracking-widest font-bold mt-1">Financial Intelligence Unit</p>
  </div>

  <nav class="hidden md:flex gap-12 text-sm font-bold text-slate-400 uppercase tracking-widest">
    <a href="dashboard.html" class="nav-link active hover:text-white">Dashboard</a>
    <a href="goal1.html" class="nav-link hover:text-white">Goals</a>
    <span class="nav-link cursor-pointer hover:text-white">Insights</span>
  </nav>

  <div class="h-12 w-12 rounded-2xl bg-slate-800 border border-white/10 flex items-center justify-center font-bold text-indigo-400">JS</div>
</header>

<main class="grid grid-cols-1 lg:grid-cols-12 gap-10">

  <!-- LEFT PANEL -->
  <div class="lg:col-span-7 space-y-10">

    <!-- FINANCIAL HEALTH -->
    <div class="glass-panel p-12 flex flex-col items-center text-center">
      <h3 class="text-xs font-black text-slate-500 uppercase tracking-widest mb-12">Financial Health Index</h3>

      <div class="relative p-2 rounded-full bg-gradient-to-tr from-indigo-500 via-purple-500 to-cyan-400">
        <div class="bg-slate-950 w-48 h-48 rounded-full flex flex-col items-center justify-center">
          <span class="text-7xl font-black">82</span>
          <span class="text-xs text-emerald-400 font-black uppercase mt-2">Excellent</span>
        </div>
      </div>

      <p class="mt-12 text-slate-400 italic text-sm max-w-sm">
        "Your spending on non-essentials dropped by 12% this week. You are on track to hit your savings goal early."
      </p>
    </div>

    <!-- SPENDING ANALYSIS -->
    <div class="glass-panel p-10">
      <div class="flex justify-between mb-8">
        <h3 class="text-sm font-bold uppercase tracking-widest text-slate-500">Spending Analysis</h3>
        <span class="text-xs font-bold text-indigo-400">Monthly View</span>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-10 items-center">
        <div class="h-56">
          <canvas id="spendingChart"></canvas>
        </div>

        <div class="space-y-6">
          <div class="p-6 bg-white/5 rounded-3xl flex justify-between items-center">
            <div>
              <p class="text-xs font-bold text-indigo-400 uppercase">Rent & Fixed</p>
              <p class="text-2xl font-black">40%</p>
            </div>
            <div class="h-2 w-16 bg-indigo-500 rounded-full"></div>
          </div>

          <div class="p-6 bg-white/5 rounded-3xl flex justify-between items-center">
            <div>
              <p class="text-xs font-bold text-emerald-400 uppercase">Lifestyle & Food</p>
              <p class="text-2xl font-black">30%</p>
            </div>
            <div class="h-2 w-16 bg-emerald-500 rounded-full"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- RIGHT PANEL (KEEP snapshot/debug + REPLACE only assistant area with chat.html code) -->
  <div class="lg:col-span-5">
    <div class="glass-panel h-[780px] flex flex-col overflow-hidden animate-in" style="animation-delay:0.1s;">

      <!-- Top header exactly like your existing dashboard assistant (title + refresh) -->
      <div class="p-8 border-b border-white/10 flex items-center justify-between">
        <span class="text-xs font-black uppercase tracking-widest">Zoro AI Assistant</span>
        <button id="refreshBtn" type="button" class="text-xs font-black uppercase tracking-widest text-indigo-300 hover:text-white transition">
          Refresh Data
        </button>
      </div>

      <!-- Tip -->
      <div class="px-8 pt-6 text-slate-400 text-sm">
        Tip: You can retrain the model (server-side) using <span class="font-mono text-indigo-200">POST /api/train</span>.
      </div>

      <!-- Live Snapshot (values stay & will update from API) -->
      <div class="p-8">
        <div class="bg-white/5 rounded-[2rem] border border-white/10 p-8">
          <p class="text-xs font-black uppercase tracking-widest text-slate-500 mb-6">Live Snapshot</p>

          <div class="grid grid-cols-2 gap-8">
            <div>
              <p class="text-xs uppercase tracking-widest text-slate-500">Income</p>
              <p id="snapIncome" class="text-2xl font-black mt-2">₹20,000</p>
            </div>

            <div>
              <p class="text-xs uppercase tracking-widest text-slate-500">Savings Rate</p>
              <p id="snapSavingsRate" class="text-2xl font-black mt-2">0%</p>
            </div>

            <div>
              <p class="text-xs uppercase tracking-widest text-slate-500">Total Expenses</p>
              <p id="snapExpenses" class="text-2xl font-black mt-2">₹0</p>
            </div>

            <div>
              <p class="text-xs uppercase tracking-widest text-slate-500">Investment</p>
              <p id="snapInvestment" class="text-2xl font-black mt-2">₹0</p>
            </div>
          </div>
        </div>

        <!-- Debug -->
        <div class="mt-6 bg-white/5 rounded-[2rem] border border-white/10 p-8">
          <p class="text-xs font-black uppercase tracking-widest text-slate-500 mb-4">Debug</p>
          <p id="debugStatus" class="text-sm text-slate-300">OK ✅ Data loaded from API</p>
        </div>
      </div>

      <!-- ✅ REPLACED PART: chat.html code embedded here (ONLY this area is chat) -->
      <div class="flex-1 px-8 pb-8 flex flex-col min-h-0">
        <!-- Chat box -->
        <div id="chatBox" class="flex-1 p-6 bg-slate-950/30 border border-white/10 rounded-[2rem] overflow-y-auto space-y-8 chat-scroll min-h-0">
          <!-- Default AI Msg -->
          <div class="flex gap-4 max-w-[90%]">
            <div class="flex-shrink-0 h-10 w-10 rounded-xl bg-indigo-600 flex items-center justify-center text-xs font-bold">AI</div>
            <div class="bg-indigo-600/10 border border-indigo-500/20 rounded-[2rem] rounded-tl-none p-6">
              <p class="text-sm leading-relaxed text-indigo-50">
                Hello! I've analyzed your recent transactions. Ready to optimize your goals today?
              </p>
            </div>
          </div>
        </div>

        <!-- Input (same as chat.html) -->
        <div class="pt-6">
          <div class="relative group">
            <input id="userInput" type="text" placeholder="Type your financial query..."
              class="w-full bg-slate-950 border border-white/10 rounded-2xl p-5 text-sm focus:outline-none focus:border-indigo-500 transition-all placeholder:text-slate-600">
            <button id="sendBtn" type="button"
              class="absolute right-4 top-1/2 -translate-y-1/2 p-2 bg-indigo-600 rounded-xl text-white hover:bg-indigo-500 transition shadow-lg shadow-indigo-600/30">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>

    </div>
  </div>

</main>

<script>
  // ========= Chat.js (from chat.html) =========
  const chatBox = document.getElementById("chatBox");
  const userInput = document.getElementById("userInput");
  const sendBtn = document.getElementById("sendBtn");

  // ✅ PUT YOUR OPENROUTER KEY HERE (TESTING ONLY)
  const OPENROUTER_API_KEY = "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";
  const MODEL = "xiaomi/mimo-v2-flash:free";

  function appendUserMessage(message) {
    const msg = document.createElement("div");
    msg.className = "flex flex-row-reverse gap-4 ml-auto max-w-[90%]";
    msg.innerHTML = `
      <div class="flex-shrink-0 h-10 w-10 rounded-xl bg-slate-800 border border-white/10 flex items-center justify-center text-xs font-bold">U</div>
      <div class="bg-slate-800/80 border border-white/10 rounded-[2rem] rounded-tr-none p-6 text-sm text-slate-300">${message}</div>
    `;
    chatBox.appendChild(msg);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function appendAIMessage(message) {
    const msg = document.createElement("div");
    msg.className = "flex gap-4 max-w-[90%]";
    msg.innerHTML = `
      <div class="flex-shrink-0 h-10 w-10 rounded-xl bg-indigo-600 flex items-center justify-center text-xs font-bold">AI</div>
      <div class="bg-indigo-600/10 border border-indigo-500/20 rounded-[2rem] rounded-tl-none p-6">
        <p class="text-sm leading-relaxed text-indigo-50">${message}</p>
      </div>
    `;
    chatBox.appendChild(msg);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function appendTypingIndicator() {
    const typing = document.createElement("div");
    typing.id = "typingIndicator";
    typing.className = "flex gap-4 max-w-[90%]";
    typing.innerHTML = `
      <div class="flex-shrink-0 h-10 w-10 rounded-xl bg-indigo-600 flex items-center justify-center text-xs font-bold">AI</div>
      <div class="bg-indigo-600/10 border border-indigo-500/20 rounded-[2rem] rounded-tl-none p-6">
        <p class="text-sm leading-relaxed text-indigo-50 italic opacity-70">Zoro is thinking...</p>
      </div>
    `;
    chatBox.appendChild(typing);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function removeTypingIndicator() {
    const typing = document.getElementById("typingIndicator");
    if (typing) typing.remove();
  }

  async function getOpenRouterResponse(userMsg) {
    const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${OPENROUTER_API_KEY}`,
        "Content-Type": "application/json",
        "HTTP-Referer": "http://localhost",
        "X-Title": "Zoro AI"
      },
      body: JSON.stringify({
        model: MODEL,
        messages: [
          { role: "system", content: "You are Zoro AI, a premium financial assistant. Respond professionally, clearly, and concisely." },
          { role: "user", content: userMsg }
        ]
      })
    });

    const data = await res.json();
    return data.choices?.[0]?.message?.content || "No response received.";
  }

  async function sendMessage() {
    const message = userInput.value.trim();
    if (!message) return;

    appendUserMessage(message);
    userInput.value = "";
    appendTypingIndicator();

    try {
      const aiReply = await getOpenRouterResponse(message);
      removeTypingIndicator();
      appendAIMessage(aiReply);
    } catch (err) {
      removeTypingIndicator();
      appendAIMessage("⚠️ Error connecting to OpenRouter. Check API key or network.");
    }
  }

  sendBtn.addEventListener("click", sendMessage);
  userInput.addEventListener("keydown", (e) => { if (e.key === "Enter") sendMessage(); });

  // ========= Dashboard chart + API refresh (keeps your data values) =========
  const ctx = document.getElementById('spendingChart').getContext('2d');
  let ringChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Rent', 'Groceries', 'Transport', 'Entertainment'],
      datasets: [{
        data: [0,0,0,0],
        backgroundColor: ['#6366f1','#10b981','#f59e0b','#3b82f6'],
        borderWidth: 0,
        cutout: '80%'
      }]
    },
    options: { plugins: { legend: { display:false } } }
  });

  function formatINR(n){
    try{
      return new Intl.NumberFormat('en-IN', { style:'currency', currency:'INR', maximumFractionDigits:0 }).format(Number(n||0));
    }catch(e){
      return `₹${Math.round(Number(n||0))}`;
    }
  }

  async function updateDashboard() {
    const debugEl = document.getElementById('debugStatus');
    try {
      debugEl.textContent = "Loading…";

      const response = await fetch('/api/predict', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          income: 50000,
          rent: 15000,
          groceries: 5000,
          transport: 2000,
          entertainment: 3000,
          investment: 10000,
          timely_loan_repayment: 1,
          goal_achievement: 1
        })
      });

      const data = await response.json();

      // Snapshot values (keep showing)
      document.getElementById('snapIncome').textContent = formatINR(data.income ?? data.Income ?? 20000);
      const sr = (data.Savings_Rate ?? data.savings_rate ?? 0);
      document.getElementById('snapSavingsRate').textContent = `${(Number(sr)*100).toFixed(0)}%`;
      document.getElementById('snapExpenses').textContent = formatINR(data.Total_Expenses ?? data.total_expenses ?? data.Expenses ?? 0);
      document.getElementById('snapInvestment').textContent = formatINR(data.investment ?? data.Investment ?? 0);

      // Chart update
      ringChart.data.datasets[0].data = [
        Number(data.Rent ?? data.rent ?? 0),
        Number(data.Groceries ?? data.groceries ?? 0),
        Number(data.Transport ?? data.transport ?? 0),
        Number(data.Entertainment ?? data.entertainment ?? 0),
      ];
      ringChart.update();

      debugEl.textContent = "OK ✅ Data loaded from API";
    } catch (error) {
      console.error("Failed to fetch model data:", error);
      debugEl.textContent = "⚠️ Failed to load data from API";
    }
  }

  document.getElementById('refreshBtn').addEventListener('click', updateDashboard);
  window.addEventListener('load', updateDashboard);
</script>

</body>
</html>
